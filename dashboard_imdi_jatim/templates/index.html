<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMDI Analytics Dashboard</title>
    
    <!-- CSS Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- FontAwesome untuk Ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-bg: #f4f7fe;
            --card-bg: #ffffff;
            --text-dark: #2b3674;
            --text-gray: #a3aed0;
        }
        body { background-color: var(--primary-bg); font-family: 'Segoe UI', sans-serif; color: var(--text-dark); }
        
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0px 4px 12px rgba(0,0,0,0.03);
            margin-bottom: 20px;
            background: var(--card-bg);
        }
        .card-header {
            background: transparent;
            border-bottom: 1px solid #f0f0f0;
            font-weight: 700;
            padding: 1.0rem 1.2rem; /* Sedikit lebih kecil padding-nya */
            color: var(--text-dark);
            font-size: 1rem;
        }
        
        /* KPI Cards */
        .kpi-value { font-size: 1.8rem; font-weight: 800; color: var(--text-dark); } /* Font sedikit dikecilkan */
        .kpi-label { color: var(--text-gray); font-size: 0.85rem; margin-bottom: 5px; }
        .kpi-icon { float: right; font-size: 1.8rem; opacity: 0.2; }
        
        /* Table Styles */
        .table-custom th { color: var(--text-gray); font-weight: 600; font-size: 0.8rem; }
        .table-custom td { font-size: 0.9rem; padding: 0.5rem; }
        .trend-up { color: #05cd99; font-weight: bold; }
        .trend-down { color: #ee5d50; font-weight: bold; }
        
        /* Simulation Box */
        .sim-input { border: 1px solid #e0e5f2; border-radius: 10px; padding: 10px; }
        .sim-result { background: #eff4fb; border-radius: 10px; padding: 15px; text-align: center; }
        
        /* Quadrant Chart Legend */
        .q-legend { font-size: 0.7rem; color: #666; margin-top: 10px; text-align: center; }
        
        /* Chart Container Fixed Height */
        .chart-container-fixed {
            position: relative;
            height: 320px; /* Tinggi fix agar tidak terlalu besar */
            width: 100%;
        }
    </style>
</head>
<body>

<div class="container-fluid p-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">Dashboard Analisis IMDI Jawa Timur</h4>
            <p class="text-muted mb-0 small">Instrumen Monitoring dan Pengambilan Kebijakan Digital</p>
        </div>
        <div>
            <select id="yearSelect" class="form-select fw-bold border-0 shadow-sm" style="width: 150px;" onchange="loadDashboard()">
                <option value="2025" selected>Tahun 2025</option>
                <option value="2024">Tahun 2024</option>
                <option value="2023">Tahun 2023</option>
                <option value="2022">Tahun 2022</option>
            </select>
        </div>
    </div>

    <!-- Row 1: KPI Utama (Contextual Data) -->
    <div class="row g-3 mb-3">
        <div class="col-md-3">
            <div class="card p-3 h-100">
                <div class="kpi-label">Rata-rata IMDI Jatim</div>
                <div class="d-flex align-items-center">
                    <div class="kpi-value me-auto" id="kpi-avg">-</div>
                    <i class="fa-solid fa-chart-line kpi-icon text-primary"></i>
                </div>
                <small class="text-muted" style="font-size: 0.75rem;">Benchmark performa wilayah</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100">
                <div class="kpi-label">Kesenjangan (Gap)</div>
                <div class="d-flex align-items-center">
                    <div class="kpi-value me-auto" id="kpi-gap">-</div>
                    <i class="fa-solid fa-arrows-left-right kpi-icon text-warning"></i>
                </div>
                <small class="text-muted" style="font-size: 0.75rem;">Selisih skor Tertinggi vs Terendah</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100">
                <div class="kpi-label">Wilayah Terendah</div>
                <div class="d-flex align-items-center">
                    <h5 class="fw-bold me-auto text-danger mb-0" id="kpi-low">-</h5>
                    <i class="fa-solid fa-arrow-trend-down kpi-icon text-danger"></i>
                </div>
                <small class="text-muted" style="font-size: 0.75rem;">Butuh intervensi segera</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 h-100">
                <div class="kpi-label">Wilayah Tertinggi</div>
                <div class="d-flex align-items-center">
                    <h5 class="fw-bold me-auto text-success mb-0" id="kpi-high">-</h5>
                    <i class="fa-solid fa-trophy kpi-icon text-success"></i>
                </div>
                <small class="text-muted" style="font-size: 0.75rem;">Model percontohan</small>
            </div>
        </div>
    </div>

    <!-- Row 2: Advanced Analysis (Quadrant & Simulation) -->
    <div class="row g-3">
        <!-- Kolom Kiri: Kuadran Analisis -->
        <div class="col-lg-8">
            <div class="card"> <!-- Hapus class h-100 agar tinggi menyesuaikan konten -->
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <span>Analisis Kuadran (Mapping Karakteristik)</span>
                    <small class="text-muted fw-normal" style="font-size: 0.75rem;">Sumbu X: Infrastruktur | Sumbu Y: Human Capital</small>
                </div>
                <div class="card-body">
                    <div class="chart-container-fixed">
                        <canvas id="quadrantChart"></canvas>
                    </div>
                    <div class="q-legend mt-2">
                        <span class="badge bg-success bg-opacity-10 text-success me-2">Q1: Maju (Digital Leader)</span>
                        <span class="badge bg-primary bg-opacity-10 text-primary me-2">Q2: Potensi Tinggi (Butuh Infra)</span>
                        <span class="badge bg-warning bg-opacity-10 text-warning me-2">Q4: Infra Siap (Butuh Pelatihan)</span>
                        <span class="badge bg-danger bg-opacity-10 text-danger">Q3: Tertinggal (Prioritas)</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kolom Kanan: Top/Bottom Tables -->
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header bg-danger bg-opacity-10 text-danger py-2">
                    <i class="fa-solid fa-triangle-exclamation me-1"></i> Bottom 5 (Perlu Perhatian)
                </div>
                <div class="card-body p-0">
                    <table class="table table-custom table-hover mb-0">
                        <thead><tr><th>Kota</th><th>Skor</th><th>Growth</th></tr></thead>
                        <tbody id="table-bottom"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card mb-0">
                <div class="card-header bg-warning bg-opacity-10 text-warning py-2">
                    <i class="fa-solid fa-arrow-trend-down me-1"></i> Tren Menurun (Watchlist)
                </div>
                <div class="card-body p-0">
                    <table class="table table-custom table-hover mb-0">
                        <thead><tr><th>Kota</th><th>Growth</th></tr></thead>
                        <tbody id="table-declining"></tbody>
                    </table>
                    <div id="no-declining" class="p-3 text-center text-muted d-none" style="font-size: 0.85rem;"><small>Tidak ada daerah menurun.</small></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Simulasi & Deep Dive -->
    <div class="row mt-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <i class="fa-solid fa-calculator me-1"></i> Simulasi Kebijakan & Deep Dive
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4 border-end">
                            <h6 class="text-muted mb-2 small fw-bold">Pilih Wilayah untuk Analisis</h6>
                            <select id="simCitySelect" class="form-select form-select-sm mb-3" onchange="analyzeCity()">
                                <option value="">-- Pilih Kota/Kab --</option>
                            </select>
                            
                            <div id="city-stats" class="d-none">
                                <h5 id="sim-city-name" class="fw-bold mb-2">NAMA KOTA</h5>
                                <div class="alert alert-info py-2 mb-2">
                                    <small>Skor Saat Ini:</small> <strong id="sim-current-score">0</strong>
                                </div>
                                <div id="recommendation-box" class="mt-2">
                                    <!-- Rekomendasi generated JS -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4 border-end">
                            <h6 class="text-muted mb-2 small fw-bold">Gap Analysis (vs Rata-rata Jatim)</h6>
                            <div style="height: 200px; width: 100%;">
                                <canvas id="comparisonChart"></canvas>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <h6 class="text-muted mb-2 small fw-bold">Simulator "What-If"</h6>
                            <p class="small text-muted mb-2" style="font-size: 0.75rem;">Geser slider untuk simulasi kenaikan pilar.</p>
                            
                            <div class="row g-1 align-items-center mb-1">
                                <div class="col-3"><label class="small">Infra</label></div>
                                <div class="col-9"><input type="range" class="form-range" id="rng-infra" min="0" max="100" oninput="runSimulation()"></div>
                            </div>
                            <div class="row g-1 align-items-center mb-1">
                                <div class="col-3"><label class="small">Skill</label></div>
                                <div class="col-9"><input type="range" class="form-range" id="rng-skill" min="0" max="100" oninput="runSimulation()"></div>
                            </div>
                            <div class="row g-1 align-items-center mb-1">
                                <div class="col-3"><label class="small">Empower</label></div>
                                <div class="col-9"><input type="range" class="form-range" id="rng-empower" min="0" max="100" oninput="runSimulation()"></div>
                            </div>
                            <div class="row g-1 align-items-center mb-1">
                                <div class="col-3"><label class="small">Job</label></div>
                                <div class="col-9"><input type="range" class="form-range" id="rng-job" min="0" max="100" oninput="runSimulation()"></div>
                            </div>
                            
                            <div class="sim-result mt-2 py-2">
                                <span class="d-block text-muted" style="font-size: 0.7rem;">Proyeksi Skor Baru</span>
                                <div class="d-flex justify-content-center align-items-baseline gap-2">
                                    <h3 class="fw-bold text-primary mb-0" id="sim-projected">0.00</h3>
                                    <small id="sim-delta" class="fw-bold text-success">+0.00</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Logic JS -->
<script>
    let quadrantChartInstance = null;
    let comparisonChartInstance = null;
    let currentCityData = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadDashboard();
        loadCityList();
    });

    async function loadDashboard() {
        const year = document.getElementById('yearSelect').value;
        try {
            const res = await fetch(`/api/dashboard_analysis?year=${year}`);
            const data = await res.json();

            if(data.error) { console.error(data.message); return; }

            // 1. Update KPI
            document.getElementById('kpi-avg').innerText = data.stats.avg;
            document.getElementById('kpi-gap').innerText = data.stats.gap;
            document.getElementById('kpi-low').innerText = data.stats.lowest;
            document.getElementById('kpi-high').innerText = data.stats.highest;

            // 2. Update Kuadran Chart
            updateQuadrantChart(data.quadrant, data.stats.avg);

            // 3. Update Tables
            const tbodyBottom = document.getElementById('table-bottom');
            tbodyBottom.innerHTML = '';
            data.bottom_5.forEach(row => {
                tbodyBottom.innerHTML += `
                    <tr>
                        <td>${row.city}</td>
                        <td>${row.score.toFixed(2)}</td>
                        <td class="${row.growth >= 0 ? 'trend-up' : 'trend-down'}">
                            ${row.growth > 0 ? '+' : ''}${row.growth}%
                        </td>
                    </tr>`;
            });

            const tbodyDeclining = document.getElementById('table-declining');
            const noDeclining = document.getElementById('no-declining');
            tbodyDeclining.innerHTML = '';
            
            if(data.declining.length === 0) {
                noDeclining.classList.remove('d-none');
            } else {
                noDeclining.classList.add('d-none');
                data.declining.forEach(row => {
                    tbodyDeclining.innerHTML += `
                        <tr>
                            <td>${row.city}</td>
                            <td class="trend-down">${row.growth}%</td>
                        </tr>`;
                });
            }
        } catch (e) {
            console.error("Gagal load dashboard", e);
        }
    }

    async function loadCityList() {
        try {
            const res = await fetch('/api/simulation_data');
            const cities = await res.json();
            const sel = document.getElementById('simCitySelect');
            cities.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                sel.appendChild(opt);
            });
        } catch(e) { console.error(e); }
    }

    function updateQuadrantChart(dataPoints, avgScore) {
        const ctx = document.getElementById('quadrantChart').getContext('2d');
        
        // --- VISUAL ADJUSTMENT ---
        // Kecilkan ukuran bubble agar tidak penuh
        const scaledData = dataPoints.map(p => ({
            ...p,
            r: p.r * 0.6 // Reduce radius by 40%
        }));

        const chartData = {
            datasets: [{
                label: 'Kab/Kota',
                data: scaledData, 
                backgroundColor: (ctx) => {
                    const val = ctx.raw;
                    if(!val) return 'rgba(100,100,100,0.5)';
                    // Warna berdasarkan Kuadran
                    if(val.x > 50 && val.y > 50) return 'rgba(5, 205, 153, 0.6)'; // Hijau
                    if(val.x <= 50 && val.y <= 50) return 'rgba(238, 93, 80, 0.6)'; // Merah
                    if(val.x > 50 && val.y <= 50) return 'rgba(255, 193, 7, 0.6)'; // Kuning
                    return 'rgba(66, 133, 244, 0.6)'; // Biru
                },
                borderWidth: 1,
                borderColor: '#fff'
            }]
        };

        if (quadrantChartInstance) quadrantChartInstance.destroy();

        quadrantChartInstance = new Chart(ctx, {
            type: 'bubble',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false, // Penting agar ikut tinggi container CSS
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                const p = ctx.raw;
                                return `${p.city}: Infra ${p.x.toFixed(1)}, SDM ${p.y.toFixed(1)}`;
                            }
                        }
                    },
                    legend: { display: false },
                    annotation: {
                        annotations: {
                            line1: { type: 'line', yMin: 50, yMax: 50, borderColor: '#ccc', borderWidth: 1, borderDash: [5,5] },
                            line2: { type: 'line', xMin: 50, xMax: 50, borderColor: '#ccc', borderWidth: 1, borderDash: [5,5] }
                        }
                    }
                },
                scales: {
                    x: { 
                        title: {display: true, text: 'Infrastruktur', font: {size: 10}}, 
                        min: 0, max: 100,
                        grid: { color: '#f0f0f0' }
                    },
                    y: { 
                        title: {display: true, text: 'SDM (Human Capital)', font: {size: 10}}, 
                        min: 0, max: 100,
                        grid: { color: '#f0f0f0' }
                    }
                },
                layout: {
                    padding: 10
                }
            }
        });
    }

    async function analyzeCity() {
        const city = document.getElementById('simCitySelect').value;
        if(!city) return;

        try {
            const res = await fetch(`/api/analyze_city?city=${city}`);
            const data = await res.json();
            
            if(!data.found) return;

            currentCityData = data.latest_data;

            // UI Updates
            document.getElementById('city-stats').classList.remove('d-none');
            document.getElementById('sim-city-name').innerText = data.city;
            document.getElementById('sim-current-score').innerText = data.latest_data.score.toFixed(2);
            
            // Rekomendasi
            const recBox = document.getElementById('recommendation-box');
            recBox.innerHTML = '<h6 class="small fw-bold">Rekomendasi Tindakan:</h6><ul class="small text-muted ps-3 mb-0" style="font-size: 0.8rem;">' + 
                data.recommendations.map(r => `<li>${r}</li>`).join('') + '</ul>';

            // Update Slider Values
            document.getElementById('rng-infra').value = data.latest_data.infra;
            document.getElementById('rng-skill').value = data.latest_data.skill;
            document.getElementById('rng-empower').value = data.latest_data.empowerment;
            document.getElementById('rng-job').value = data.latest_data.job;
            
            runSimulation(); 

            updateComparisonChart(data.latest_data, data.prov_avg);
        } catch(e) { console.error(e); }
    }

    function updateComparisonChart(cityData, provData) {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        
        if (comparisonChartInstance) comparisonChartInstance.destroy();

        comparisonChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Infra', 'Skill', 'Empower', 'Job'],
                datasets: [
                    {
                        label: 'Kota',
                        data: [cityData.infra, cityData.skill, cityData.empowerment, cityData.job],
                        backgroundColor: '#4318FF',
                        borderRadius: 3,
                        barPercentage: 0.6
                    },
                    {
                        label: 'Jatim',
                        data: [provData.infra, provData.skill, provData.empowerment, provData.job],
                        backgroundColor: '#E9EDF7',
                        borderRadius: 3,
                        barPercentage: 0.6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { beginAtZero: true, max: 100, grid: { display: false } },
                    x: { grid: { display: false }, ticks: { font: { size: 9 } } }
                },
                plugins: {
                    legend: { labels: { boxWidth: 10, font: { size: 10 } } }
                }
            }
        });
    }

    function runSimulation() {
        if(!currentCityData) return;

        const infra = parseFloat(document.getElementById('rng-infra').value);
        const skill = parseFloat(document.getElementById('rng-skill').value);
        const empower = parseFloat(document.getElementById('rng-empower').value);
        const job = parseFloat(document.getElementById('rng-job').value);

        const newScore = (infra + skill + empower + job) / 4;
        
        const diff = newScore - currentCityData.score;
        const diffEl = document.getElementById('sim-delta');
        
        document.getElementById('sim-projected').innerText = newScore.toFixed(2);
        
        if(diff >= 0) {
            diffEl.innerText = "+" + diff.toFixed(2);
            diffEl.className = "fw-bold text-success small";
        } else {
            diffEl.innerText = diff.toFixed(2);
            diffEl.className = "fw-bold text-danger small";
        }
    }
</script>

</body>
</html>